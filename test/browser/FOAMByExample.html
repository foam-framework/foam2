<html>
 <head>
  <script>console.time('boot');</script>
  <script language="javascript" src="../../src/foam.js"></script>
  <script>console.timeEnd('boot');</script>
  <script language="javascript" src="../helpers/Exemplar.js"></script>
  <script language="javascript" src="FOAMByExample.js"></script>
  <title>FOAM By Example</title>
  <style>
    body { white-space: pre-wrap; }
    code { color:blue; }
  </style>
 </head>

 <body>
  <div id="examples"></div>


  <script>
    // Run FBE Exemplars in browser
    var oldContext;
    var oldConsole = console;
    foam.async.repeat(FBE.length, function runExemplar(index) {
      var ex = FBE[index];
      // Note: eval() for each exemplar may be async, so don't
      // nuke the context without waiting for the promise to resolve
      if ( oldContext) foam.__context__ = oldContext;

      oldContext = foam.__context__;
      foam.__context__ = foam.createSubContext({});

      // TODO: make log output pretty, put in a div
      var output = [];
      var logger = function() {
        output.push(Array.prototype.join.call(arguments, ' '));
      };
      var writeOutput = function() {
        // write log output
        document.write("<pre>" + output.join('\n') + "</pre>");
      }
      console = {
        __proto__: oldConsole,
        log: logger,
        warn: logger,
        error: logger,
        debug: logger
      }

      var code = ex.generateExample();
      // TODO: offer expandable view of complete dependencies
      // Write the code with deps omitted
      document.write("<hr><code>" + ex.generateExample(true) + "</code>");
      // TODO: capture eval's document modifications the way foam1 flow.FBE did
      var result = eval("(function runExemplar___() { " + code + " })();");

      // if not async
      if ( result && result.then ) {
        return result.then(writeOutput);
      } else {
        writeOutput();
        return result;
      }
    })();
  </script>
 </body>
</html>
